@section Scripts {
    <script src="~/js/Patient/formValidation.js"></script>
    <script src="~/js/Patient/formSubmission.js"></script>
}

@{
    ViewData["Title"] = "Inquire Patient Information";
}

<div id="patientForm">
    <div class="modal-header">
        <h1 class="display-4">Inquire Patient Information</h1>
    </div>

    <div class="modal-body">
        <div class="row">
            <div class="form-inline col-md-3">
                <label class="control-label">Patient ID</label>
                <input type="text" class="form-control" id="SearchPatientId" name="SearchPatientId" value="">
            </div>
            <div class="form-inline col-md-3">
                <label class="control-label">Nationality ID Number</label>
                <input type="text" class="form-control" id="SearchIdNo" name="SearchIdNo" value="">
            </div>
            <div class="form-inline col-md-3">
                <label class="control-label">Family (Last) Name</label>
                <input type="text" class="form-control" id="SearchFamilyName" name="SearchFamilyName" value="">
            </div>
            <div class="form-inline col-md-3">
                <label class="control-label">Given (First) Name</label>
                <input type="text" class="form-control" id="SearchGivenName" name="SearchGivenName" value="">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onClick="Query()">Inquire</button>
        </div>

        <table class="table table-striped" id="patientList" style="display: none">
            <thead style="vertical-align: middle;">
                <tr>
                    <th></th>
                    <th>Patient ID</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Nationality ID</th>
                    <th>Birthday</th>
                </tr>
                <tbody></tbody>
            </thead>
        </table>    
        <div>
            <span id="noData" style="display: none">Query information not found.</span>
        </div>
    </div>
</div>

<script>
    function Query() {
        $.ajax({
            url: '@Url.Content("~/Patient/Query")',
            method: 'GET',
            datatype: 'json',
            data: {
                patientId: document.getElementById("SearchPatientId").value,
                idNo: document.getElementById("SearchIdNo").value,
                familyName: document.getElementById("SearchFamilyName").value,
                givenName: document.getElementById("SearchGivenName").value
            },

            success: function (result) {
                if (result.status !== 'error') {
                    alert("Successfully inquired.");
                    if (result.length > 0) {
                        document.getElementById("patientList").style.display = "block";
                        document.getElementById("noData").style.display = "none";
                        SearchList(result);
                    } else {
                        document.getElementById("patientList").style.display = "none";
                        document.getElementById("noData").style.display = "block";
                    }
                    return;
                }
                alert(result.message);
            },
            error: function (err) {
                console.error(err);
                alert(err.statusText || "An error occurred.");
            }
        });
    }

        function SearchList(result) {
        const tableBody = document.getElementById("patientList").querySelector("tbody");

        // Clear existing rows
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }

        // Populate table with new data
        result.forEach(patient => {
            const row = tableBody.insertRow();

            // Create cells
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            const cell3 = row.insertCell(2);
            const cell4 = row.insertCell(3);
            const cell5 = row.insertCell(4);
            const cell6 = row.insertCell(5);

            // Populate cells
            cell1.innerHTML = `
                <button type="button" class="btn btn-warning" onClick="Update(${patient.patientId})">Modify</button>
                <button type="button" class="btn btn-danger" onClick="Delete(${patient.patientId})">Delete</button>`;
            cell2.innerHTML = patient.patientId;
            cell3.innerHTML = `${patient.familyName} ${patient.givenName}`;
            cell4.innerHTML = (patient.gender === 'M') ? 'Male' : 'Female';
            cell5.innerHTML = patient.idNo;
            cell6.innerHTML = new Date(patient.birthday).toLocaleDateString('zh-tw', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        });
    }

</script>